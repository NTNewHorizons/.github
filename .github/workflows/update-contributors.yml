name: Update Contributors

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-all-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Step 1: Checkout all repositories
      - name: Checkout .github repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.UNIVERSAL_FINE }}
          path: github-repo

      - name: Checkout NTNH repository
        uses: actions/checkout@v4
        with:
          repository: NTNewHorizons/NTNH
          token: ${{ secrets.UNIVERSAL_FINE }}
          path: ntnh-repo

      - name: Checkout NTNH-Translations repository
        uses: actions/checkout@v4
        with:
          repository: NTNewHorizons/NTNH-Translations
          token: ${{ secrets.UNIVERSAL_FINE }}
          path: translations-repo

      # Step 2: Set up environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: Update GitHub code contributors
      - name: Fetch all code contributors
        id: fetch-contributors
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.UNIVERSAL_FINE }}
          script: |
            const org = 'NTNewHorizons';
            
            // Fetch all repositories in the organization
            const { data: repos } = await github.rest.repos.listForOrg({
              org: org,
              type: 'public',
              per_page: 100
            });
            
            console.log(`Found ${repos.length} repositories in ${org}`);
            
            // Collect all contributors from non-forked repos only
            const contributorMap = new Map();
            let processedRepos = 0;
            let skippedForks = 0;
            
            for (const repo of repos) {
              // Skip forked repositories
              if (repo.fork) {
                console.log(`Skipping forked repository: ${repo.name}`);
                skippedForks++;
                continue;
              }
              
              try {
                const { data: contributors } = await github.rest.repos.listContributors({
                  owner: org,
                  repo: repo.name,
                  per_page: 100
                });
                
                for (const contributor of contributors) {
                  if (contributor.type === 'User') {
                    if (contributorMap.has(contributor.login)) {
                      contributorMap.get(contributor.login).contributions += contributor.contributions;
                    } else {
                      contributorMap.set(contributor.login, {
                        login: contributor.login,
                        avatar_url: contributor.avatar_url,
                        html_url: contributor.html_url,
                        contributions: contributor.contributions
                      });
                    }
                  }
                }
                
                console.log(`Fetched ${contributors.length} contributors from ${repo.name}`);
                processedRepos++;
              } catch (error) {
                console.log(`Error fetching contributors for ${repo.name}: ${error.message}`);
              }
            }
            
            console.log(`\nProcessed ${processedRepos} repositories, skipped ${skippedForks} forks`);
            
            // Sort by contributions (descending)
            const sortedContributors = Array.from(contributorMap.values())
              .sort((a, b) => b.contributions - a.contributions);
            
            console.log(`Total unique contributors: ${sortedContributors.length}`);
            
            // Generate HTML
            let html = '<div align="center">\n  <h2>ðŸŒŸ Our Amazing Contributors ðŸŒŸ</h2>\n';
            
            for (const contributor of sortedContributors) {
              html += `  <a href="${contributor.html_url}">\n`;
              html += `    <img src="${contributor.avatar_url}" width="50" height="50" alt="${contributor.login}" style="border-radius: 50%; margin: 5px;" title="${contributor.login} (${contributor.contributions} contributions)">\n`;
              html += `  </a>\n`;
            }
            
            html += '</div>\n';
            
            // Read and update README files
            const fs = require('fs');
            
            const readmePaths = [
              'github-repo/profile/README.md',
              'ntnh-repo/README.md'
            ];
            
            for (const readmePath of readmePaths) {
              try {
                let readmeContent = fs.readFileSync(readmePath, 'utf8');
                
                // Replace content between markers
                const startMarker = '<!-- CONTRIBUTORS_START -->';
                const endMarker = '<!-- CONTRIBUTORS_END -->';
                const startIndex = readmeContent.indexOf(startMarker);
                const endIndex = readmeContent.indexOf(endMarker);
                
                if (startIndex !== -1 && endIndex !== -1) {
                  const before = readmeContent.substring(0, startIndex + startMarker.length);
                  const after = readmeContent.substring(endIndex);
                  readmeContent = before + '\n' + html + after;
                  fs.writeFileSync(readmePath, readmeContent);
                  console.log(`Successfully updated ${readmePath} with contributors`);
                } else {
                  console.log(`Could not find contributor markers in ${readmePath}`);
                }
              } catch (error) {
                console.log(`File ${readmePath} not found or error: ${error.message}`);
              }
            }
            
            return { count: sortedContributors.length };

      # Step 4: Generate Crowdin contributors table for .github
      - name: Generate Crowdin Contributors for .github
        uses: andrii-bodnar/action-crowdin-contributors@v3
        with:
          contributors_per_line: 7
          max_contributors: 50
          image_size: 50
          min_words_contributed: 10
          include_languages: false
          placeholder_start: '<!-- CROWDIN_CONTRIBUTORS_START -->'
          placeholder_end: '<!-- CROWDIN_CONTRIBUTORS_END -->'
          files: 'github-repo/profile/README.md'
        env:
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Wrap Crowdin table in .github with centered div
        run: |
          perl -i -pe '
            BEGIN { $/ = undef; }
            s/<!-- CROWDIN_CONTRIBUTORS_START -->\n(.*?)<!-- CROWDIN_CONTRIBUTORS_END -->/<!-- CROWDIN_CONTRIBUTORS_START -->\n<div align="center">\n  <h2>ðŸŒŸ Our Wonderful Translation Contributors ðŸŒŸ<\/h2>\n  \n$1<\/div>\n<!-- CROWDIN_CONTRIBUTORS_END -->/gs
          ' github-repo/profile/README.md

      # Step 5: Generate Crowdin contributors table for NTNH
      - name: Generate Crowdin Contributors for NTNH
        uses: andrii-bodnar/action-crowdin-contributors@v3
        with:
          contributors_per_line: 7
          max_contributors: 50
          image_size: 50
          min_words_contributed: 10
          include_languages: false
          placeholder_start: '<!-- CROWDIN_CONTRIBUTORS_START -->'
          placeholder_end: '<!-- CROWDIN_CONTRIBUTORS_END -->'
          files: 'ntnh-repo/README.md'
        env:
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Wrap Crowdin table in NTNH with centered div
        run: |
          perl -i -pe '
            BEGIN { $/ = undef; }
            s/<!-- CROWDIN_CONTRIBUTORS_START -->\n(.*?)<!-- CROWDIN_CONTRIBUTORS_END -->/<!-- CROWDIN_CONTRIBUTORS_START -->\n<div align="center">\n  <h2>ðŸŒŸ Our Wonderful Translation Contributors ðŸŒŸ<\/h2>\n  \n$1<\/div>\n<!-- CROWDIN_CONTRIBUTORS_END -->/gs
          ' ntnh-repo/README.md

      # Step 6: Generate Crowdin contributors table for Translations
      - name: Generate Crowdin Contributors for Translations
        uses: andrii-bodnar/action-crowdin-contributors@v3
        with:
          contributors_per_line: 7
          max_contributors: 50
          image_size: 50
          min_words_contributed: 10
          include_languages: false
          placeholder_start: '<!-- CROWDIN_CONTRIBUTORS_START -->'
          placeholder_end: '<!-- CROWDIN_CONTRIBUTORS_END -->'
          files: 'translations-repo/README.md'
        env:
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Wrap Crowdin table in Translations with centered div
        run: |
          perl -i -pe '
            BEGIN { $/ = undef; }
            s/<!-- CROWDIN_CONTRIBUTORS_START -->\n(.*?)<!-- CROWDIN_CONTRIBUTORS_END -->/<!-- CROWDIN_CONTRIBUTORS_START -->\n<div align="center">\n  <h2>ðŸŒŸ Our Wonderful Translation Contributors ðŸŒŸ<\/h2>\n  \n$1<\/div>\n<!-- CROWDIN_CONTRIBUTORS_END -->/gs
          ' translations-repo/README.md

      # Step 7: Commit and push all changes to .github repository
      - name: Commit and push .github repository
        run: |
          cd github-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add profile/README.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit in .github repo"
          else
            git commit -m "ðŸ¤– Auto-update contributors list"
            git push
          fi

      # Step 8: Commit and push all changes to NTNH repository
      - name: Commit and push NTNH repository
        run: |
          cd ntnh-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit in NTNH repo"
          else
            git commit -m "ðŸ¤– Auto-update contributors list"
            git push
          fi

      # Step 9: Commit and push all changes to NTNH-Translations repository
      - name: Commit and push NTNH-Translations repository
        run: |
          cd translations-repo
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit in NTNH-Translations repo"
          else
            git commit -m "ðŸ¤– Auto-update contributors list"
            git push
          fi

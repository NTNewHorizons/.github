name: Update Contributors

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fetch all contributors
        id: fetch
        uses: actions/github-script@v7
        with:
          script: |
            const orgs = ['NTNewHorizons', 'GTNewHorizons'];
            
            // Collect all contributors from all repos across all organizations
            const contributorMap = new Map();
            
            for (const org of orgs) {
              console.log(`\nFetching repositories for ${org}...`);
              
              // Fetch all repositories in the organization
              const { data: repos } = await github.rest.repos.listForOrg({
                org: org,
                type: 'public',
                per_page: 100
              });
              
              console.log(`Found ${repos.length} repositories in ${org}`);
              
              for (const repo of repos) {
                try {
                  const { data: contributors } = await github.rest.repos.listContributors({
                    owner: org,
                    repo: repo.name,
                    per_page: 100
                  });
                  
                  for (const contributor of contributors) {
                    if (contributor.type === 'User') {
                      if (contributorMap.has(contributor.login)) {
                        contributorMap.get(contributor.login).contributions += contributor.contributions;
                      } else {
                        contributorMap.set(contributor.login, {
                          login: contributor.login,
                          avatar_url: contributor.avatar_url,
                          html_url: contributor.html_url,
                          contributions: contributor.contributions
                        });
                      }
                    }
                  }
                  
                  console.log(`Fetched ${contributors.length} contributors from ${org}/${repo.name}`);
                } catch (error) {
                  console.log(`Error fetching contributors for ${org}/${repo.name}: ${error.message}`);
                }
              }
            }
            
            // Sort by contributions (descending)
            const sortedContributors = Array.from(contributorMap.values())
              .sort((a, b) => b.contributions - a.contributions);
            
            console.log(`\nTotal unique contributors across all organizations: ${sortedContributors.length}`);
            
            // Generate HTML
            let html = '<p align="center">\n  <strong>ðŸŒŸ Our Amazing Contributors ðŸŒŸ</strong><br><br>\n';
            
            for (const contributor of sortedContributors) {
              html += `  <a href="${contributor.html_url}">\n`;
              html += `    <img src="${contributor.avatar_url}" width="50" height="50" alt="${contributor.login}" title="${contributor.login} (${contributor.contributions} contributions)" style="border-radius: 50%; margin: 5px;" />\n`;
              html += `  </a>\n`;
            }
            
            html += '</p>\n';
            
            // Read the README file
            const fs = require('fs');
            const readmePath = 'profile/README.md';
            let readmeContent = fs.readFileSync(readmePath, 'utf8');
            
            // Replace content between markers
            const startMarker = '<!-- CONTRIBUTORS_START -->';
            const endMarker = '<!-- CONTRIBUTORS_END -->';
            
            const startIndex = readmeContent.indexOf(startMarker);
            const endIndex = readmeContent.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readmeContent.substring(0, startIndex + startMarker.length);
              const after = readmeContent.substring(endIndex);
              readmeContent = before + '\n' + html + after;
              
              fs.writeFileSync(readmePath, readmeContent);
              console.log('Successfully updated README.md with contributors');
            } else {
              console.error('Could not find contributor markers in README.md');
            }
            
            return { count: sortedContributors.length };
      
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add profile/README.md
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update contributors list"
            git push
          fi
